<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√âtape 3 : Utiliser les Documents - Mini-RAG</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/cftl_icon.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/search.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center; gap: 20px; flex-wrap: wrap; margin-bottom: 20px;">
                <a href="https://www.cftl.fr" target="_blank" rel="noopener noreferrer" style="flex: 0 0 auto;">
                    <img src="{{ url_for('static', filename='images/cftl_logo.svg') }}" alt="CFTL Logo" style="height: 60px; transition: transform 0.3s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                </a>
                <div style="flex: 1; text-align: center;">
                    <h1>ü§ñ Mini-RAG : Recherche Augment√©e par G√©n√©ration</h1>
                    <p class="subtitle">√âtape 3 : Utiliser les Documents</p>
                </div>
                <a href="https://www.uaestqb.ae" target="_blank" rel="noopener noreferrer" style="flex: 0 0 auto;">
                    <img src="{{ url_for('static', filename='images/uaestqb_logo.svg') }}" alt="UAESTQB Logo" style="height: 60px; transition: transform 0.3s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                </a>
            </div>
            {% include 'navigation.html' %}
            
            <!-- Configuration Info -->
            <div class="config-info" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; border-radius: 8px; margin-top: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <span style="font-weight: bold; font-size: 1.1em;">üîß Configuration:</span>
                    <div style="display: flex; gap: 20px; flex-wrap: wrap; flex: 1;">
                        <div style="background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 5px;">
                            <strong>Embeddings:</strong> 
                            {% if embedding_mode == 'local' %}
                                üè° Local (Sentence Transformers)
                            {% else %}
                                ‚òÅÔ∏è OpenAI
                            {% endif %}
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 5px;">
                            <strong>LLM:</strong> 
                            {% if llm_mode == 'local' %}
                                üè° Local ({{ ollama_model }})
                            {% else %}
                                ‚òÅÔ∏è OpenAI ({{ openai_model }})
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main>
            <!-- Info sur l'index -->
            <section class="index-info">
                <div class="info-card">
                    <h3>üìä Index Disponible</h3>
                    <div id="indexInfo" class="index-stats">
                        <div class="stat">
                            <span class="stat-label">Documents :</span>
                            <span class="stat-value" id="docCount">-</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Chunks :</span>
                            <span class="stat-value" id="chunkCount">-</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Mod√®le :</span>
                            <span class="stat-value" id="modelName">-</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Zone de chat -->
            <section class="chat-section">
                <div class="chat-container">
                    <div class="chat-header">
                        <h3>üí¨ Posez vos questions</h3>
                        <p>Le syst√®me recherchera dans vos documents index√©s et g√©n√©rera une r√©ponse contextuelle</p>
                    </div>

                    <div class="chat-messages" id="chatMessages">
                        <div class="message system-message">
                            <div class="message-icon">‚ÑπÔ∏è</div>
                            <div class="message-content">
                                <p><strong>Bienvenue !</strong></p>
                                <p>Posez vos questions sur les documents que vous avez index√©s. Le syst√®me utilisera FAISS pour trouver les passages pertinents et {% if llm_mode == 'local' %}{{ ollama_model }} (Ollama){% else %}OpenAI{% endif %} pour g√©n√©rer une r√©ponse coh√©rente.</p>
                                <p class="hint">üí° Exemples : "Quelles sont les √©tapes d√©crites ?", "Explique le concept principal", "Quelle est la conclusion du document ?"</p>
                            </div>
                        </div>
                    </div>

                    <div class="chat-input-container">
                        <div style="display: grid; grid-template-columns: auto auto; gap: 10px; margin-bottom: 10px; align-items: center; justify-content: start;">
                            <button id="clearHistoryBtn" class="clear-button" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 0.9em;">
                                üóëÔ∏è Effacer l'historique
                            </button>
                            <span id="historyCount" style="color: #666; padding: 8px; font-size: 0.9em;">
                                Historique: 0 messages
                            </span>
                            <span id="tokenCount" style="color: #667eea; padding: 8px; font-size: 0.9em; font-weight: 600; background: #f0f4ff; border-radius: 5px; grid-column: 1 / -1;">
                                üéØ Tokens utilis√©s: 0
                            </span>
                        </div>
                        <textarea 
                            id="questionInput" 
                            class="chat-input" 
                            placeholder="Tapez votre question ici..."
                            rows="3"
                        ></textarea>
                        <button id="sendBtn" class="send-button">
                            <span class="send-icon">üì§</span>
                            <span class="send-text">Envoyer</span>
                        </button>
                    </div>
                </div>
            </section>

            <!-- Param√®tres de recherche -->
            <section class="settings-section">
                <details>
                    <summary>‚öôÔ∏è Param√®tres avanc√©s</summary>
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label for="topK">üìä Nombre de chunks √† r√©cup√©rer (top_k)</label>
                            <input type="number" id="topK" value="5" min="1" max="20">
                            <small><strong>Qu'est-ce que c'est ?</strong> Nombre de morceaux de texte les plus pertinents r√©cup√©r√©s dans vos documents index√©s.</small>
                            <p class="param-explanation">
                                üí° <strong>Impact :</strong><br>
                                ‚Ä¢ <strong>Peu de chunks (1-3) :</strong> R√©ponse tr√®s cibl√©e mais peut manquer de contexte<br>
                                ‚Ä¢ <strong>Valeur moyenne (4-7) :</strong> Bon √©quilibre entre pr√©cision et contexte (recommand√©)<br>
                                ‚Ä¢ <strong>Beaucoup (8+) :</strong> Plus de contexte mais risque d'informations non pertinentes
                            </p>
                        </div>
                        
                        <div class="setting-item">
                            <label for="temperature">üå°Ô∏è Temp√©rature (cr√©ativit√©)</label>
                            <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.7">
                            <output id="tempValue">0.7</output>
                            <small><strong>Qu'est-ce que c'est ?</strong> Contr√¥le le degr√© de cr√©ativit√© et de variabilit√© des r√©ponses du LLM.</small>
                            <p class="param-explanation">
                                üí° <strong>Impact :</strong><br>
                                ‚Ä¢ <strong>0.0-0.3 :</strong> R√©ponses tr√®s factuelles, pr√©visibles et d√©terministes<br>
                                ‚Ä¢ <strong>0.4-0.7 :</strong> √âquilibre entre pr√©cision et cr√©ativit√© (recommand√© pour tests)<br>
                                ‚Ä¢ <strong>0.8-1.0 :</strong> R√©ponses plus cr√©atives mais potentiellement moins pr√©cises
                            </p>
                        </div>
                        
                        <div class="setting-item">
                            <label for="maxTokens">üìù Longueur maximale de la r√©ponse (tokens)</label>
                            <input type="number" id="maxTokens" value="500" min="100" max="2000" step="50">
                            <small><strong>Qu'est-ce que c'est ?</strong> Limite le nombre de mots/tokens que le LLM peut g√©n√©rer dans sa r√©ponse.</small>
                            <p class="param-explanation">
                                üí° <strong>Impact :</strong><br>
                                ‚Ä¢ <strong>100-300 tokens :</strong> R√©ponses courtes et concises<br>
                                ‚Ä¢ <strong>400-600 tokens :</strong> R√©ponses d√©taill√©es (recommand√©)<br>
                                ‚Ä¢ <strong>700+ tokens :</strong> R√©ponses tr√®s compl√®tes et exhaustives<br>
                                <em>Note : 1 token ‚âà 0.75 mot en fran√ßais</em>
                            </p>
                        </div>

                        <div class="setting-item">
                            <label for="showSources">
                                <input type="checkbox" id="showSources" checked>
                                üîç Afficher les sources utilis√©es
                            </label>
                            <small><strong>Qu'est-ce que c'est ?</strong> Affiche les extraits de documents utilis√©s pour g√©n√©rer la r√©ponse.</small>
                            <p class="param-explanation">
                                üí° <strong>Utilit√© :</strong> Permet de v√©rifier la tra√ßabilit√© et la fiabilit√© des r√©ponses en voyant les sources exactes consult√©es par le LLM. Essentiel pour la transparence et la validation des r√©sultats.
                            </p>
                        </div>

                        <div class="setting-item" style="grid-column: 1 / -1;">
                            <label for="systemPrompt">ü§ñ Prompt syst√®me (personnalit√© du LLM)</label>
                            <textarea id="systemPrompt" rows="15" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 0.9em; resize: vertical;">Tu es un testeur certifi√© ISTQB (International Software Testing Qualifications Board) avec une expertise approfondie en assurance qualit√© logicielle. 

Ton r√¥le est d'assister dans toutes les activit√©s de test selon le processus ISTQB :

1. **Analyse des tests** : Identifier les conditions de test √† partir des exigences et sp√©cifications
2. **Conception des tests** : Cr√©er des cas de test d√©taill√©s, des sc√©narios et des donn√©es de test
3. **Impl√©mentation des tests** : Pr√©parer les scripts de test et l'environnement de test
4. **Ex√©cution des tests** : D√©finir les proc√©dures d'ex√©cution et les crit√®res de validation

Tu bases tes r√©ponses sur les documents fournis et tu appliques les bonnes pratiques ISTQB. Tu peux :
- Analyser des sp√©cifications pour identifier les cas de test
- Cr√©er des cas de test d√©taill√©s avec pr√©conditions, √©tapes et r√©sultats attendus
- Proposer des strat√©gies de test adapt√©es
- Identifier les risques et prioriser les tests
- R√©diger des rapports de test professionnels

Si l'information n'est pas dans les documents, tu le dis clairement et tu proposes une approche bas√©e sur les standards ISTQB.</textarea>
                            <small><strong>Qu'est-ce que c'est ?</strong> Instructions qui d√©finissent la personnalit√©, le r√¥le et le comportement du LLM.</small>
                            <p class="param-explanation">
                                üí° <strong>Utilit√© :</strong> Le prompt syst√®me influence fortement le style et la qualit√© des r√©ponses. Vous pouvez le modifier pour adapter le LLM √† vos besoins sp√©cifiques (ex: expert s√©curit√©, testeur agile, analyste performance, etc.).
                            </p>
                        </div>
                    </div>
                </details>
            </section>

            <!-- Section API cURL -->
            <section class="api-section" style="background: #f8f9fa; padding: 25px; border-radius: 15px; margin-top: 30px;">
                <h3 style="color: #667eea; margin-bottom: 20px;">üîå Utilisation via API (cURL)</h3>
                <p style="margin-bottom: 15px; color: #555;">
                    Vous pouvez √©galement interroger le syst√®me directement via l'API REST :
                </p>
                
                <div style="position: relative;">
                    <pre id="curlCode" style="background: #2d2d2d; color: #f8f8f2; padding: 20px; border-radius: 8px; overflow-x: auto; font-size: 0.9em; line-height: 1.6; margin: 0;"><code>curl -X POST http://localhost:5000/api/search -H "Content-Type: application/json" -d "{\"question\": \"Quels sont les principes de base du test logiciel selon ISTQB?\", \"top_k\": 5, \"temperature\": 0.7, \"max_tokens\": 500}"</code></pre>
                    <button id="copyBtn" onclick="copyCurlCommand()" style="position: absolute; top: 10px; right: 10px; background: #667eea; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 0.85em; transition: all 0.3s;">
                        üìã Copier
                    </button>
                </div>

                <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 8px; border-left: 4px solid #667eea;">
                    <h4 style="margin: 0 0 10px 0; color: #667eea; font-size: 1em;">Param√®tres :</h4>
                    <ul style="margin: 0; padding-left: 20px; color: #555; line-height: 1.8;">
                        <li><code style="background: #f0f4ff; padding: 2px 6px; border-radius: 3px; color: #667eea;">question</code> (requis) : Votre question en langage naturel</li>
                        <li><code style="background: #f0f4ff; padding: 2px 6px; border-radius: 3px; color: #667eea;">top_k</code> (optionnel) : Nombre de chunks √† r√©cup√©rer (d√©faut: 5)</li>
                        <li><code style="background: #f0f4ff; padding: 2px 6px; border-radius: 3px; color: #667eea;">temperature</code> (optionnel) : Cr√©ativit√© du LLM 0-1 (d√©faut: 0.7)</li>
                        <li><code style="background: #f0f4ff; padding: 2px 6px; border-radius: 3px; color: #667eea;">max_tokens</code> (optionnel) : Longueur max de la r√©ponse (d√©faut: 500)</li>
                    </ul>
                </div>
            </section>
        </main>

        <footer>
            <p>¬© 2025 CFTL JTIA - Tutoriel Mini-RAG | Paris</p>
        </footer>
    </div>

    <script src="{{ url_for('static', filename='js/search.js') }}"></script>
    <script>
        function copyCurlCommand() {
            // Commande cURL sur une seule ligne pour Windows cmd
            const curlCommand = 'curl -X POST http://localhost:5000/api/search -H "Content-Type: application/json" -d "{\\"question\\": \\"Quels sont les principes de base du test logiciel selon ISTQB?\\", \\"top_k\\": 5, \\"temperature\\": 0.7, \\"max_tokens\\": 500}"';
            
            navigator.clipboard.writeText(curlCommand).then(() => {
                const btn = document.getElementById('copyBtn');
                const originalText = btn.innerHTML;
                const originalBg = btn.style.background;
                
                btn.innerHTML = '‚úÖ Copi√© !';
                btn.style.background = '#28a745';
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = originalBg;
                }, 2000);
            }).catch(err => {
                console.error('Erreur de copie:', err);
                alert('Erreur lors de la copie. Veuillez copier manuellement.');
            });
        }
    </script>
</body>
</html>
